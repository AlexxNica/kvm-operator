machine:
    services:
        - docker

dependencies:
    override:
        # circleci normally does this behind the scenes,
        # but as we need to override the inference to stop it running `go get`,
        # we need to do this manually
        - mkdir -p $HOME/.go_project/src/github.com/$CIRCLE_PROJECT_USERNAME
        - ln -fs $HOME/$CIRCLE_PROJECT_REPONAME $HOME/.go_project/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
        - |
          echo 'export GOPATH=$GOPATH:$HOME/.go_project' >> ~/.circlerc

test:
    override:
        - go test -v
        - CGO_ENABLED=0 GOOS=linux go build -a -tags netgo -ldflags '-w' -v
        - docker build --rm=false -t registry.giantswarm.io/giantswarm/cluster-controller:$CIRCLE_SHA1 .
        - docker run registry.giantswarm.io/giantswarm/cluster-controller:$CIRCLE_SHA1 --help

deployment:
    master:
        branch: master
        commands:
            - docker login --email=$DOCKER_EMAIL --username=$DOCKER_USERNAME --password="$DOCKER_PASSWORD" registry.giantswarm.io
            - docker push registry.giantswarm.io/giantswarm/cluster-controller:$CIRCLE_SHA1
